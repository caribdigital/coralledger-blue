@rendermode InteractiveServer
@using Microsoft.JSInterop
@inject IJSRuntime JsRuntime

<div class="connection-status" role="status" aria-live="polite">
    <span class="status-dot @(IsOnline ? "online" : "offline")" aria-hidden="true"></span>
    <div class="status-copy">
        <strong>@StatusText</strong>
        <small>@(IsSyncing ? "Syncing..." : PendingCopy)</small>
    </div>
    <button class="btn btn-sm btn-outline-light @(IsSyncing ? "syncing" : "")"
            type="button"
            @onclick="TriggerSync"
            disabled="@(!IsOnline || IsSyncing)"
            title="@(IsSyncing ? "Syncing in progress..." : "Sync pending changes")">
        <i class="bi bi-arrow-repeat @(IsSyncing ? "spinning" : "")"></i>
        @(IsSyncing ? "Syncing..." : "Sync now")
    </button>
</div>

@code {
    [Parameter] public int PendingCount { get; set; }
    [Parameter] public bool IsSyncing { get; set; }
    [Parameter] public EventCallback OnManualSync { get; set; }

    private bool IsOnline { get; set; } = true;
    private bool _justSynced;
    private int _previousPendingCount;

    private string StatusText => IsOnline ? "Online" : "Offline";
    private string PendingCopy
    {
        get
        {
            if (_justSynced) return "Synced!";
            if (PendingCount > 0) return $"{PendingCount} pending actions";
            return "All caught up";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                IsOnline = await JsRuntime.InvokeAsync<bool>("navigator.onLine");
            }
            catch
            {
                IsOnline = true;
            }
            _previousPendingCount = PendingCount;
            StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        // Detect when pending count decreased (sync completed)
        if (!IsSyncing && _previousPendingCount > PendingCount && PendingCount >= 0)
        {
            _justSynced = true;
            _ = ClearSyncedMessageAsync();
        }
        _previousPendingCount = PendingCount;
    }

    private async Task ClearSyncedMessageAsync()
    {
        await Task.Delay(1500);
        _justSynced = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task TriggerSync()
    {
        if (OnManualSync.HasDelegate)
        {
            await OnManualSync.InvokeAsync(null);
        }
    }
}
